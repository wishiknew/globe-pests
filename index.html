<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globe Pests - World Tour</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            color: #333;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            position: absolute;
            top: 20px;
            left: 40px;
            font-size: 2em;
            font-weight: 300;
        }

        #globe-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
        }

        #country-name {
            position: absolute;
            top: 80px;
            left: 40px;
            font-size: 1.5em;
            font-weight: 400;
            color: #666;
        }

        #pest-list {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pest-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            border-left: 3px solid #ccc;
            opacity: 0;
            transform: translateX(20px);
            animation: slideIn 0.3s forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .pest-item.critical {
            border-left-color: #ff3333;
        }

        .pest-item.high {
            border-left-color: #ff9933;
        }

        .pest-item.medium {
            border-left-color: #ffcc33;
        }

        .pest-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .pest-scientific {
            font-style: italic;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }

        .pest-crops {
            font-size: 0.85em;
            color: #888;
        }

        .country-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Global Agricultural Pests</h1>
    <div id="country-name"></div>
    <div id="pest-list"></div>
    <div id="globe-container"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
        // Versor class for smooth quaternion-based rotation interpolation
        class Versor {
            static fromAngles([l, p, g]) {
                l *= Math.PI / 360;
                p *= Math.PI / 360;
                g *= Math.PI / 360;
                const sl = Math.sin(l), cl = Math.cos(l);
                const sp = Math.sin(p), cp = Math.cos(p);
                const sg = Math.sin(g), cg = Math.cos(g);
                return [
                    cl * cp * cg + sl * sp * sg,
                    sl * cp * cg - cl * sp * sg,
                    cl * sp * cg + sl * cp * sg,
                    cl * cp * sg - sl * sp * cg
                ];
            }
            static toAngles([a, b, c, d]) {
                return [
                    Math.atan2(2 * (a * b + c * d), 1 - 2 * (b * b + c * c)) * 180 / Math.PI,
                    Math.asin(Math.max(-1, Math.min(1, 2 * (a * c - d * b)))) * 180 / Math.PI,
                    Math.atan2(2 * (a * d + b * c), 1 - 2 * (c * c + d * d)) * 180 / Math.PI
                ];
            }
            static interpolateAngles(a, b) {
                const i = Versor.interpolate(Versor.fromAngles(a), Versor.fromAngles(b));
                return t => Versor.toAngles(i(t));
            }
            static interpolateLinear([a1, b1, c1, d1], [a2, b2, c2, d2]) {
                a2 -= a1, b2 -= b1, c2 -= c1, d2 -= d1;
                const x = new Array(4);
                return t => {
                    const l = Math.hypot(x[0] = a1 + a2 * t, x[1] = b1 + b2 * t, x[2] = c1 + c2 * t, x[3] = d1 + d2 * t);
                    x[0] /= l, x[1] /= l, x[2] /= l, x[3] /= l;
                    return x;
                };
            }
            static interpolate([a1, b1, c1, d1], [a2, b2, c2, d2]) {
                let dot = a1 * a2 + b1 * b2 + c1 * c2 + d1 * d2;
                if (dot < 0) a2 = -a2, b2 = -b2, c2 = -c2, d2 = -d2, dot = -dot;
                if (dot > 0.9995) return Versor.interpolateLinear([a1, b1, c1, d1], [a2, b2, c2, d2]);
                const theta0 = Math.acos(Math.max(-1, Math.min(1, dot)));
                const x = new Array(4);
                const l = Math.hypot(a2 -= a1 * dot, b2 -= b1 * dot, c2 -= c1 * dot, d2 -= d1 * dot);
                a2 /= l, b2 /= l, c2 /= l, d2 /= l;
                return t => {
                    const theta = theta0 * t;
                    const s = Math.sin(theta);
                    const c = Math.cos(theta);
                    x[0] = a1 * c + a2 * s;
                    x[1] = b1 * c + b2 * s;
                    x[2] = c1 * c + c2 * s;
                    x[3] = d1 * c + d2 * s;
                    return x;
                };
            }
        }
    </script>
    <script>
        const container = document.getElementById('globe-container');
        const countryNameDiv = document.getElementById('country-name');

        // Dimensions
        const width = window.innerWidth;
        const height = Math.min(window.innerHeight, 720);

        // Prepare canvas
        const dpr = window.devicePixelRatio || 1;
        const canvas = d3.create("canvas")
            .attr("width", dpr * width)
            .attr("height", dpr * height)
            .style("width", `${width}px`);

        container.appendChild(canvas.node());

        const context = canvas.node().getContext("2d");
        context.scale(dpr, dpr);

        // Create projection and path generator
        const projection = d3.geoOrthographic()
            .fitExtent([[10, 10], [width - 10, height - 10]], {type: "Sphere"});

        const path = d3.geoPath(projection, context);
        const tilt = 20;

        // Load data
        let world, land, borders, countries, pestsData;
        const pestListDiv = document.getElementById('pest-list');

        // Country ID to ISO code mapping
        const idToCode = {
            840: 'US', 356: 'IN', 76: 'BR', 156: 'CN', 404: 'KE',
            36: 'AU', 250: 'FR', 392: 'JP', 484: 'MX', 710: 'ZA',
            32: 'AR', 360: 'ID', 764: 'TH', 566: 'NG', 818: 'EG',
            124: 'CA', 276: 'DE', 380: 'IT', 724: 'ES', 792: 'TR',
            586: 'PK', 704: 'VN', 608: 'PH', 170: 'CO'
        };

        Promise.all([
            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'),
            d3.json('pests-by-country.json')
        ]).then(([worldData, pests]) => {
            world = worldData;
            land = topojson.feature(world, world.objects.land);
            borders = topojson.mesh(world, world.objects.countries, (a, b) => a !== b);
            countries = topojson.feature(world, world.objects.countries).features;
            pestsData = pests;

            // Filter to only countries with pest data
            countries = countries.filter(country => {
                const code = idToCode[country.id];
                return code && pests.countries.some(c => c.code === code);
            });

            console.log('Loaded', countries.length, 'countries with pest data');

            // Start the tour
            startTour();
        }).catch(error => {
            console.error('Error loading data:', error);
            countryNameDiv.textContent = 'Error loading data';
        });

        function render(country, arc) {
            context.clearRect(0, 0, width, height);

            // Draw land (grey)
            context.beginPath();
            path(land);
            context.fillStyle = "#ccc";
            context.fill();

            // Draw current country (red)
            context.beginPath();
            path(country);
            context.fillStyle = "#f00";
            context.fill();

            // Draw borders (white)
            context.beginPath();
            path(borders);
            context.strokeStyle = "#fff";
            context.lineWidth = 0.5;
            context.stroke();

            // Draw sphere outline (black)
            context.beginPath();
            path({type: "Sphere"});
            context.strokeStyle = "#000";
            context.lineWidth = 1.5;
            context.stroke();

            // Draw arc if provided
            if (arc) {
                context.beginPath();
                path(arc);
                context.strokeStyle = "#000";
                context.lineWidth = 1;
                context.stroke();
            }
        }

        async function showPests(countryCode) {
            const countryPests = pestsData.countries.find(c => c.code === countryCode);
            if (!countryPests) {
                pestListDiv.innerHTML = '';
                return;
            }

            pestListDiv.innerHTML = `<div class="country-title">${countryPests.name}</div>`;

            // Show pests one by one with delay
            for (let i = 0; i < countryPests.pests.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 300));

                const pest = countryPests.pests[i];
                const pestDiv = document.createElement('div');
                pestDiv.className = `pest-item ${pest.severity}`;
                pestDiv.innerHTML = `
                    <div class="pest-name">${pest.name}</div>
                    <div class="pest-scientific">${pest.scientificName}</div>
                    <div class="pest-crops">Affects: ${pest.cropsAffected.join(', ')}</div>
                `;
                pestListDiv.appendChild(pestDiv);
            }
        }

        async function startTour() {
            console.log('Starting tour...');

            let p1, p2 = [0, 0], r1, r2 = [0, 0, 0];

            // Infinite loop
            while (true) {
                for (const country of countries) {
                    const countryCode = idToCode[country.id];

                    console.log('Visiting:', country.properties.name);

                    // Update country name
                    countryNameDiv.textContent = country.properties.name;

                    // Clear pest list
                    pestListDiv.innerHTML = '';

                    // Render current country
                    render(country);

                    // Calculate positions for transition
                    p1 = p2;
                    p2 = d3.geoCentroid(country);
                    r1 = r2;
                    r2 = [-p2[0], tilt - p2[1], 0];

                    const ip = d3.geoInterpolate(p1, p2);
                    const iv = Versor.interpolateAngles(r1, r2);

                    // Transition to country with animation
                    try {
                        await d3.transition()
                            .duration(1250)
                            .tween("render", () => t => {
                                projection.rotate(iv(t));
                                render(country, {type: "LineString", coordinates: [p1, ip(t)]});
                            })
                            .end();
                    } catch(e) {
                        console.log('Transition interrupted');
                    }

                    // Show pests for this country
                    if (countryCode) {
                        await showPests(countryCode);
                    }

                    // Wait before moving to next country
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            location.reload();
        });
    </script>
</body>
</html>
